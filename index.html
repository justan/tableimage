<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<title>tableImage example</title>
  <script type="text/javascript" src="lib/tableimage.js"></script>
  <script type="text/javascript">
  </script>
  <style type="text/css">
    body{
      margin:10px 50px 50px;
      background-color: #e9e9e9;
      color: #333;
    }
    
    .control{
      font-size: 18px;
    }
    #picUrl{
      width: 480px;
    }
    #res{
      width: 400px;
      height: 250px;
    }
    
    
    .loading{ position: relative; }
    .loading:after{
      background: url("loading.gif") no-repeat center;
      content: ".";
      z-index: 2;
      display: block;
      height: 100%;
      width: 100%;
      position: absolute;
      top: 0;
      left: 0;
    }
    
    .i{
      padding: 5px;
      font-size: 18px;
    }
    
    .b{
      display: inline-block;
      vertical-align: top;
      width: 45%;
      overflow: hidden;
    }
    
  </style>
</head>
<body>
  <a href="https://github.com/justan/tableimage">
    <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub">
  </a>
  <h1><a href="https://github.com/justan/tableimage">tableimage</a> 在线生成器</h1>
  <p>电子邮件中的图片默认会被邮件客户端拦截下来. 通过 tableiamge 转换成 HTML `table` 标签的图片则不会有此问题.</p>
  <br />
    <ol>
    	<li>生成的代码可用于在电子邮件中直接显示图片. </li>
    	<li>甚至可以将半透 png 图片完美的在 ie6 中显示.</li>
    	<li>node.js / 浏览器支持. </li>
    	<li>不要转换大尺寸图片而不设 max-width 或 max-height. </li>
    	<li>不要用来发垃圾邮件. </li>
    </ol>
  <hr />
  <div class="control">
    <p>图片的地址：</p>
    <input class="i" type="url" id="picUrl" name="picUrl" value="http://justan.github.io/tableimage/taiji.png" />
    <br />
    <br />
    <label for="max-width">max-width: 
      <input class="i" type="number" id="max-width" value="250" size="3" maxLength="3" pattern="\d{0,3}" />
    </label>
    <label for="max-height">max-height: 
      <input class="i" type="number" id="max-height" value="250" size="3" maxLength="3" pattern="\d{0,3}" />
    </label>
    
    <label for="oldie">生成的代码是否需要支持 IE 6/7/8?
      <input type="checkbox" name="oldid" id="oldie"/>
    </label>
    <label for="bg">背景色(可选): 
      #<input class="i" type="text" id="bg" size="6" maxLength="6" pattern="([0-9a-f]{6})?" /> 
    </label>
    <br />
    <button class="i" id="go" onclick="doSth()">转换</button>
  </div>
  
  <hr />
  
  <div id="show">
    <div class="b">
      <p>原图：</p>
      <div id="origin">
        <img id="pic" alt="原始图片" />
      </div>
    </div>
    <div class="b">
      <p>HTML Table 图：</p>
      <div id="out"></div>
    </div>
    <div class="b">
      <p>代码<span id="len"></span>: </p>
      <textarea id="res"></textarea>
    </div>
  </div>
<script type="text/javascript">
var doSth;
(function(){
  var img = document.getElementById('pic')
    , out = document.getElementById('out')
    , show = document.getElementById('show')
    , maxWidth = document.getElementById('max-width')
    , maxHeight = document.getElementById('max-height')
    , res = document.getElementById('res')
    , oldie = document.getElementById('oldie')
    , go = document.getElementById('go')
    , origin = document.getElementById('origin')
    , len = document.getElementById('len')
    , bg = document.getElementById('bg')
    ;
    
  function convert(url){
    origin.className = "loading";
    img.onload = function(){
      try{
        var background;
        if(bg.value){
          background = [
              parseInt(bg.value.substring(0, 2), 16)
            , parseInt(bg.value.substring(2, 4), 16)
            , parseInt(bg.value.substring(4, 6), 16)
          ];
          console.log(background)
        }
        var table = tableImage.convert(img, {
            ignoreOldIE: !oldie.checked
          , background: background
          , maxWidth: maxWidth.value
          , maxHeight: maxHeight.value
        });
        out.innerHTML = table;
        res.value = table;
        len.innerHTML = ' (' + table.length + ')';
      }catch(e){
        if(e.code === 18){
          out.innerHTML = "<strong>你需要用一个更现代的浏览器. 比如 firefox, chrome 的最新版</strong>"
        }
      }
      origin.className = "";
    };
    img.onerror = function(){
      out.innerHTML = 'image load failed';
      origin.className = "";
    };
    img.crossOrigin = '';
    img.src = url;
  }  
  doSth = function(){
    var url = document.getElementById('picUrl').value;
    url = url.replace(/^https\:\/\//, 'http://');
    var proxy = 'http://proxy.whosemind.net/?url='
    convert(proxy + decodeURIComponent(url));
  };
  
  if(isCanvasSupported()){
    doSth();
  }else{
    document.body.innerHTML = '<strong><a href="https://github.com/justan/tableimage">tableImage</a>: 请用一个现代浏览器打开该页面...</strong>'
  }
  
  function isCanvasSupported(){
    var elem = document.createElement('canvas');
    return !!(elem.getContext && elem.getContext('2d'));
  }
})();
</script>
</body>
</html>
